name: Deploy to Droplet

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      # --- Build API ---
      - name: Build API via Nx
        run: |
          NODE_OPTIONS="--max-old-space-size=2048" npx nx build api --configuration=production

      # âœ… IMPORTANT: create runtime dist package.json + lockfile + workspace_modules for @shopit/*
      - name: Prepare API runtime (prune + copy workspace modules)
        run: |
          npx nx run api:prune

          echo "API dist content:"
          ls -lah apps/api/dist || true
          echo "workspace_modules (top):"
          find apps/api/dist/workspace_modules -maxdepth 3 -type d | sed -n '1,120p'

      - name: Create web env file for build
        run: |
          {
            echo "NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL }}"
            echo "NEXT_PUBLIC_API_PREFIX=${{ vars.NEXT_PUBLIC_API_PREFIX }}"
          } > apps/web/.env.production
      
      - name: Verify web env file (safe)
        run: |
          echo "NEXT_PUBLIC_API_URL=$(grep NEXT_PUBLIC_API_URL apps/web/.env.production | sed 's/=.*/=*** /')"
          echo "NEXT_PUBLIC_API_PREFIX=$(grep NEXT_PUBLIC_API_PREFIX apps/web/.env.production | sed 's/=.*/=*** /')"


      # --- Build WEB ---
      - name: Build WEB via Nx
        run: |
          NODE_OPTIONS="--max-old-space-size=4096" npx nx build web --configuration=production

      # Create deploy bundle (no node_modules, but INCLUDE api/dist/workspace_modules)
      - name: Prepare deploy bundle
        run: |
          rm -rf deploy
          mkdir -p deploy/apps/api deploy/apps/web

          # API dist (includes main.js + package.json + package-lock.json + workspace_modules)
          rsync -a --delete \
            --exclude ".git" \
            --exclude "node_modules" \
            --exclude ".nx" \
            --exclude "tmp" \
            --exclude ".env" \
            --exclude ".env.*" \
            apps/api/dist/ deploy/apps/api/dist/

          # WEB dist
          rsync -a --delete \
            --exclude ".git" \
            --exclude "node_modules" \
            --exclude ".nx" \
            apps/web/.next/ deploy/apps/web/.next/

          rsync -a apps/web/public/ deploy/apps/web/public/ || true
          rsync -a apps/web/package.json deploy/apps/web/package.json || true

          # Root files (optional, keep if you want)
          rsync -a package.json package-lock.json nx.json deploy/ || true
          rsync -a ecosystem.config.cjs deploy/ || true

          echo "Deploy bundle content (API dist top-level):"
          find deploy/apps/api/dist -maxdepth 2 -type f | sed -n '1,200p'
          echo "Deploy bundle content (workspace_modules top):"
          find deploy/apps/api/dist/workspace_modules -maxdepth 3 -type d | sed -n '1,120p'

      - name: Upload bundle to droplet (rsync over SSH)
        uses: burnett01/rsync-deployments@v8
        with:
          switches: -avzr --delete --exclude ".env" --exclude ".env.*"
          path: deploy/
          remote_path: ${{ secrets.APP_DIR }}/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_port: ${{ secrets.SSH_PORT }}
          remote_key: ${{ secrets.SSH_KEY }}

      - name: Install production deps & restart PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm use 20

            cd "${{ secrets.APP_DIR }}"

            echo "Node:"
            node -v
            npm -v

            # Install prod deps ONCE at repo root (this is where the API will resolve them from)
            npm ci --omit=dev --no-audit --no-fund

            # Make sure dist doesn't have its own node_modules (prevents Nest duplicate module identity)
            rm -rf apps/api/dist/node_modules || true

            pm2 startOrReload ecosystem.config.cjs
            pm2 save
            pm2 status
